---
title: "Data Analysis"
author: "Brendan Chapuis"
date: "4/10/2020"
output: html_document
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r libraries, include = FALSE}

library(lubridate)
library(randomForest)
library(tidymodels)
library(forcats)
library(broom)
library(rsample)
library(yardstick)
library(readr)
library(tidyverse)

```


```{r data, echo = FALSE}

dem_primary <- read_csv("data/processed-data/dem_primary.csv") %>% 
  select(-X1)

final_results_data <- read_csv("data/processed-data/final_results_data.csv") %>% 
  select(-X1)

```

```{r}

forest_mod <- rand_forest() %>%
  set_engine("randomForest") %>%
  set_mode("classification")

logistic_mod <- logistic_reg() %>%
  set_engine("glm")

vote_split <- initial_split(final_results_data)
vote_train <- training(vote_split)
vote_test <- testing(vote_split)

logistic_fit <- fit(logistic_mod,
                    factor(winner) ~ poll_estimate + market_close,
                    data = vote_train)

vote_forest <- fit(forest_mod,
                    factor(winner) ~ poll_estimate,
                    data = vote_train)

poll_market_form <- formula(factor(winner) ~ poll_estimate + market_close)

logistic_mod %>%
  fit(poll_market_form, data = vote_train) %>%
  predict(new_data = vote_test) %>%
  bind_cols(vote_test) %>% 
  rmse(truth = winner, estimate = .pred_class)

```


```{r analysis, echo = FALSE}

predictions <- final_results_data %>%
  group_by(state) %>% 
  arrange(desc(market_close)) %>% 
  mutate(winner = as.numeric(as.character(winner)),
         market_rank = 1:n(),
         market_winner = ifelse(market_rank == 1, 1, 0),
         poll_cutoff = ifelse(poll_estimate > 0.1, 1, 0),
         viable_candidates = sum(poll_cutoff),
         num_candidates = n()) %>%
  arrange(desc(poll_estimate)) %>% 
  mutate(poll_rank = 1:n(),
         poll_winner = ifelse(poll_rank == 1, 1, 0),
         log_market = qlogis(market_close),
         neg_log = ifelse(log_market < 0, 1, 0)) %>% 
  ungroup()


predictions %>% 
  mutate(forest_prediction = predict(vote_forest, new_data = predictions) %>%  pull(.pred_class),
         logistic_prediction = predict(logistic_fit, new_data = predictions) %>%  pull(.pred_class)) %>% 
  filter(winner == 1) %>%
  view()
  summarize(forest_correct = sum(as.numeric(as.character(forest_prediction)))/n(),
            logistic_correct = sum(as.numeric(as.character(logistic_prediction)))/n())

predictions %>% 
  filter(winner == 1) %>% 
  lm(vote_percent ~ num_candidates, data = .) %>% 
  summary()

predictions %>% 
  ggplot(aes(x = num_candidates, y = vote_percent)) +
  geom_point()

predictions %>% 
  lm(vote_percent ~ poll_estimate * poly(market_close, 3, raw=TRUE), data = .) %>%
  summary()

  augment(newdata = predictions) %>% 
  group_by(state) %>% 
  arrange(desc(.fitted)) %>% 
  mutate(predicted_rank = 1:n()) %>%
  ungroup() %>% 
  filter(final_rank == 1) %>% 
  mutate(predicted_correct = ifelse(final_rank == predicted_rank, 1, 0)) %>%
  summarize(percent_correct = sum(predicted_correct)/n())
  
predictions %>% 
  filter(final_rank == 1) %>% 
  mutate(correct = ifelse(final_rank == poll_rank, 1, 0)) %>% 
  summarize(percent_correct = sum(correct)/n())
  
poll_model <- lm(formula = vote_percent ~ poll_estimate, data = final_results_data)

market_model <- lm(formula = vote_percent ~ poly(market_close, 3, raw=TRUE), data = final_results_data)

final_results_data$poll_model <- predict(poll_model, newdata = final_results_data)

final_results_data$market_model <- predict(market_model, newdata = final_results_data)


```